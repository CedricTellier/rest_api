<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

	<title>Rest API Caddev</title>
	<style type="text/css">
		td ,tr{
		  text-align: center;
		}
		</style>
  </head>
 
  <body>
	  <h1 style="text-align: center;">
		Rest API Caddev
	  </h1>
	  <div style="margin-left: 50px;margin-right:50px">
		<h2 style="margin-top:50px;">Get Employees</h2>
		<div class="row"style="margin-top:25px;">
			<div class="col-2">
				<a class="btn btn-primary" onclick="getAllEmployees()" role="button">All Employees</a>
			</div>
			<div class="col-2">
				<a class="btn btn-secondary" onclick="getAllEmployees('Caddev/')" role="button">Caddev's Employees</a>
			</div>
			<div class="col-2">
				<a class="btn btn-success" onclick="getAllEmployees('Cadcom/')" role="button">Cadcom's Employees</a>
			</div>
			<div class="col-2">
				<a class="btn btn-danger" onclick="getAllEmployees('Capture4cad/')" role="button">Capture4Cad's Employees</a>
			</div>
			<div class="col-2">
				<a class="btn btn-warning" onclick="getAllEmployees('CadworkSA/')" role="button">Cadwork SA's Employees</a>
			</div>
			<div class="col-2">
				<a class="btn btn-secondary" onclick="getAllEmployees('Cadwork/')"  role="button">Cadwork France's Employees</a>
			</div>
			<div class="col-2">
				<a class="btn btn-info" onclick="getAllEmployees('Cadskills/')"  role="button">CadSkills Employees</a>
			</div>
		</div>
		<div style="margin-top:25px;">
			<table class="table table-dark" id='mytTable'>
				<thead>
				  <tr>
					<th scope="col">Id</th>
					<th scope="col">Firstname</th>
					<th scope="col">LastName</th>
					<th scope="col">Company</th>
					<th scope="col">Birth Date</th>
					<th scope="col">Creation Date</th>
					<th scope="col">Actions</th>
				  </tr>
				</thead>
				<tbody>
				  <tr id='myTd'>
					<td colspan="6">No Values</td>
				  </tr>
				</tbody>
			</table>
		</div>
		<h2 style="margin-top:50px;">Create an Employee</h2>
		<div class="row" style="margin-top:25px;">
			<div class="col-6">
				<form>
					<div class="form-group">
						<label for="firstname">First Name</label>
						<input type="text" class="form-control" id="firstname" placeholder="Enter a Firstname" required>
					</div>
					<div class="form-group">
						<label for="lastname">Last Name</label>
						<input type="text" class="form-control" id="lastname" placeholder="Enter a Lastname" required>
					</div>
					<div class="form-group">
						<label for="business">Select a Company</label>
						<select class="form-control" id="business">
						<option value="Caddev">Caddev</option>
						<option value="CadworkSA">Cadwork SA</option>
						<option value="Cadwork">Cadwork France</option>
						<option value="Cadcom">Cadcom</option>
						<option value="Cadskills">Cadskills</option>
						<option value="Capture4cad">Capture4Cad</option>
						</select>
					</div>
					<a type="submit" class="btn btn-primary" onclick="createNewEmployee()" role="button">Create</a>
				</form>
			</div>
			<div class="col-6"></div>
		</div>
		<!-- Modal -->
		<div class="modal fade" id="modifyModal" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
				<h5 class="modal-title" id="modifyLabel">Modify an Employee</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
				</div>
				<div class="modal-body">
					<div class="form-group">
						<label for="">Employee Id</label>
						<input type="text" class="form-control" id="employeeId" disabled>
					</div>					
					<div class="form-group">
						<label for="firstnameModify">First Name</label>
						<input type="text" class="form-control" id="firstnameModify" placeholder="Enter a Firstname" required>
					</div>
					<div class="form-group">
						<label for="lastnameModify">Last Name</label>
						<input type="text" class="form-control" id="lastnameModify" placeholder="Enter a Lastname" required>
					</div>
					<div class="form-group">
						<label for="businessModify">Select a Company</label>
						<select class="form-control" id="businessModify">
						<option value="Caddev">Caddev</option>
						<option value="CadworkSA">Cadwork SA</option>
						<option value="Cadwork">Cadwork France</option>
						<option value="Cadcom">Cadcom</option>
						<option value="Cadskills">Cadskills</option>
						<option value="Capture4cad">Capture4Cad</option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
				<button id="cancelModify" type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" onclick="modifyEmployee()">Save</button>
				</div>
			</div>
			</div>
		</div>
	</div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	<script>
		var globalIndex = 0;
		function createNewEmployee()
		{
			var firstname = document.getElementById("firstname").value;
			var lastname = document.getElementById("lastname").value;
			if(!firstname.length)
			{
				return alert('le champs du prénom est manquant, merci de la compléter!');
			}
			else if (!lastname.length)
			{
				return alert('le champs du nom de famille est manquant, merci de la compléter!');
			}
			var business = document.getElementById("business").options[document.getElementById("business").selectedIndex].value;	
			let formData = {'lastname': lastname, 'firstname': firstname, 'business': business };
 
			var formBody = [];
			for (var property in formData) {
				var encodedKey = encodeURIComponent(property);
				var encodedValue = encodeURIComponent(formData[property]);
				formBody.push(encodedKey + "=" + encodedValue);
			}
			formBody = formBody.join("&");

			fetch('https://restapitellierc.herokuapp.com/employees', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
				},				
				body: formBody
			})
			.then(response => console.log(response))
			.catch(error => console.log(error))
			if(business.length)
			{
				business += "/";
				getAllEmployees(business);
			}
			else {
				getAllEmployees();
			}
		}

		function deleteEmployee(row)
		{
			var id = row.dataset.id;
			if(id !== null || id !== 'undefined')
			{
				fetch("https://restapitellierc.herokuapp.com/employees/" + id, {
					method: 'delete'
				})
				.then(response => console.log(response))
				.catch(error => console.log(error))
			}
			var url = null;
			switch(globalIndex)
			{
				case 1:
					url = "Caddev/";
				break;
				case 2:
					url = "Cadcom/";
				break;
				case 3:
					url = "Capture4cad/";
				break;
				case 4:
					url = "CadworkSA/";
				break;
				case 5:
					url = "Cadwork/";
				break;
				case 5:
					url = "Cadskills/";
				break;
				default:
					url = null;
				break;
			}
			getAllEmployees(url);
		}

		function launchModify(row)
		{
			var employee = row.dataset.employee;
			var json = JSON.parse(employee);
			console.log(json.firstname, json._id, json.lastname, json.business);
			document.getElementById("employeeId").value = json._id;
			document.getElementById("firstnameModify").value = json.firstname;
			document.getElementById("lastnameModify").value = json.lastname;
			selectElement("businessModify", json.business);
		}


		function modifyEmployee()
		{
			var id = document.getElementById("employeeId").value;
			var firstname =  document.getElementById("firstnameModify").value;
			var lastname = document.getElementById("lastnameModify").value;
			var business = document.getElementById("businessModify").options[document.getElementById("businessModify").selectedIndex].value;	

			var config = { firstname : firstname, lastname: lastname, business:business };
			
			var formBody = [];
			for (var property in config) {
				var encodedKey = encodeURIComponent(property);
				var encodedValue = encodeURIComponent(config[property]);
				formBody.push(encodedKey + "=" + encodedValue);
			}
			formBody = formBody.join("&");

			fetch('https://restapitellierc.herokuapp.com/employees/' + id, {
				method: 'PUT',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
				},				
				body: formBody
			})
			.then(response => console.log(response))
			.catch(error => console.log(error))
			document.getElementById("cancelModify").click();
			var url = null;
			switch(globalIndex)
			{
				case 1:
					url = "Caddev/";
				break;
				case 2:
					url = "Cadcom/";
				break;
				case 3:
					url = "Capture4cad/";
				break;
				case 4:
					url = "CadworkSA/";
				break;
				case 5:
					url = "Cadwork/";
				break;
				case 5:
					url = "Cadskills/";
				break;
				default:
					url = null;
				break;
			}
			getAllEmployees(url);
		}

		function selectElement(id, valueToSelect) {    
			let element = document.getElementById(id);
			element.value = valueToSelect;
		}

		function getAllEmployees(business = null)
		{
			if(business == "Caddev/")
			{
				globalIndex = 1;
			}
			else if(business == "Cadcom/")
			{
				globalIndex = 2;
			}
			else if(business == "Capture4cad/")
			{
				globalIndex = 3;
			}
			else if(business == "CadworkSA/")
			{
				globalIndex = 4;
			}
			else if(business == "Cadwork/")
			{
				globalIndex = 5;
			}
			else if(business == "Cadskills/")
			{
				globalIndex = 6;
			}
			var url =null;
			if(business == null)
			{
				url = "https://restapitellierc.herokuapp.com/employees";
			}
			else
			{
				url = "https://restapitellierc.herokuapp.com/" + business + "employees";
			}
			fetch(url).then(function(response) {
				response.json().then(function(json) {
					var tableHeaderRowCount = 1;
					var table = document.getElementById("mytTable");
					var rowCount = table.rows.length;
					for (var i = tableHeaderRowCount; i < rowCount; i++) {
						table.deleteRow(tableHeaderRowCount);
					}
					for(var i = 0; i < json.length; i++) {
						var obj = json[i];
						var row = table.insertRow(-1);
						
						var idCell = row.insertCell(0);
						let idText = document.createTextNode(obj._id);
						idCell.appendChild(idText);

						var firstnameCell = row.insertCell(1);
						let firstnameText = document.createTextNode(obj.firstname);
						firstnameCell.appendChild(firstnameText);

						var lastnameCell = row.insertCell(2);
						let lastnameText = document.createTextNode(obj.lastname);
						lastnameCell.appendChild(lastnameText);

						var businessCell = row.insertCell(3);
						let businessText = document.createTextNode(obj.business);
						businessCell.appendChild(businessText);

						var birthdateCell = row.insertCell(4);
						let birthdayText = document.createTextNode(obj.birth_date);
						birthdateCell.appendChild(birthdayText);

						var creationCell = row.insertCell(5);
						let creationText = document.createTextNode(obj.created_date);
						creationCell.appendChild(creationText);

						var actionCell = row.insertCell(6);
						var id = obj._id
						actionCell.innerHTML = '<a class="btn btn-warning" onclick="launchModify(this)" data-employee='+ JSON.stringify(obj) + ' role="button" data-toggle="modal" data-target="#modifyModal">Modify</a><a class="btn btn-danger" style="margin-left:10px" onclick="deleteEmployee(this)" data-id='+ obj._id +' role="button">Delete</a>';
					}
				});
			});
		}
	</script>
  </body>
</html>